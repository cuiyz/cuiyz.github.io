<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>译文：基于Docker的构建(第二部分) － 持续部署</title>
</head>
<body style="text-indent:2em">
<h1 align="center">译文：基于Docker的构建(第二部分) － 持续部署</h1>
<p align="center">原作者:Usman Ismail, Bilal Sheikh &nbsp;&nbsp;&nbsp;&nbsp; 译者:崔远智</p>

<p>在之前的文章中，我们已经看到了关于“<a href="http://rancher.com/deploying-a-scalable-jenkins-cluster-with-docker-and-rancher/">如何基于Docker搭建一个Jenkins的CI环境</a>”以及“<a href="http://rancher.com/docker-based-build-pipelines-part-1-continuous-integration-and-testing/">利用Docker搭建持续集成环境</a>”的阐述。因为使用了Docker，所以我们的集中控制构建环境可以扩展至任何数量的机器。同时，在Jenkins的CI环境基础上实现了全自动的持续构建、打包和测试。</p>

<p>本篇文章中，我们将更进一步，实现将项目持续发布到测试环境中去，实现测试的自动化运行。自动测试环境能够在产品正式上线前很好的帮助你发现问题。
同时，这个环境的经验也会对你如何持续发布产品到生产环境产生帮助，在接下来到几篇文章中我们也会持续探讨。
</p>

<p align="center"><img src="images/cd_flow-1024x275.png" style="width:auto;max-width:800px"></p>

<h2>使用Docker和Rancher创建长测环境</h2>
<p>我们对应用完成构建和测试之后，就可以把它发布到长测环境，它甚至是外部可访问的。这个环境将允许QA甚至用户在产品发布到生产环境前进行测试。
这个环境是生产环境部署之前非常重要的一个环节，因为它能够让我们从真实环境中挖掘更多的bug，而不单单是自动化测试而以。我们通常把这个环境叫做“质保”环境或“集成环境”。
像<a href="http://rancher.com/docker-based-build-pipelines-part-1-continuous-integration-and-testing/">上一篇</a>文章一样，我们将使用<a href="https://github.com/usmanismail/go-messenger">go-messenger</a>项目的go-auth组件来创建我们的测试环境。具体步骤如下：
</p>
<p>1.在Rancher中创建一个集成环境</p>
<p>2.定义Docker Compose和Rancher Compose模版</p>
<p>3.使用Rancher创建应用栈</p>
<p>4.使用Rancher和AWS Route53管理DNS纪录</p>
<p>5.添加HTTPS支持</p>

<h3>在Rancher中创建一个集成环境</h3>
<p>在Rancher界面中，有上角选择“Manage Environments”并且“Add Environment”。在弹出的界面中添加名字“Integration”并根据需求添加描述。
同时，你也要选择可以访问这个环境的用户和组织。</p>
<p align="center"><img src="images/Screen-Shot-2015-10-26-at-10.33.44-PM.png" style="width:auto;max-width:600px"></p>

<p>创建完成以后，在左上角选择你刚刚创建好的“Integration”环境。现在我们就可以创建一个应用栈了。另外，我们需要在右上角菜单选择“API & Keys”来添加API Key。
在弹出菜单中添加API Key Pair的名字。这个key会在接下来的创建Rancher Compose等步骤用到。
我们给密钥起名“JenkinsKey”，因为接下来的rancher compose要运行Jenkins实例。将“key”和“secret”拷贝下来并妥善保存，因为他们只会在这里显示一次。
注意：每一个环境都要使用单独的Key来管理，所以我们需要针对所有的环境都单独创建一个key。</p>
<p align="center"><img src="images/api_keys.png" style="width:auto;max-width:700px"></p>

<h3>定义Docker Compose和Rancher Compose模版</h3>
<p>在<a href="http://rancher.com/docker-based-build-pipelines-part-1-continuous-integration-and-testing/">上一篇</a>文章中，
我们创建了docker compose模版来定义项目需要的容器类型，如下。我们将使用跟之前一样的docker compose模版，但是会增加新的auth-lb服务。
这样，就会在我们的go-auth服务前增加负载均衡服务，在所有的容器间进行分流。
在服务前增加负载均衡的目的是实现高可用和可扩展，使得在某一个或多个服务容器已经失效的情况下仍然可以提供服务。
此外，它还可以把负载分散到可能的不同物理主机上。
</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
mysql-master:
 image: mysql
 environment:
   MYSQL_ROOT_PASSWORD: rootpass
   MYSQL_DATABASE: messenger
   MYSQL_USER: messenger
   MYSQL_PASSWORD: messenger
 expose:
 - "3306"
 stdin_open: true
 tty: true
auth-service:
  tty: true
  command:
  - --db-host
  - mysql-master
  - -p
  - '9000'
  image: usman/go-auth:${auth_version}
  links:
  - mysql-master:mysql-master
  stdin_open: true

auth-lb:
  ports:
  - '9000'
  expose:
  - 9090:9000
  tty: true
  image: rancher/load-balancer-service
  links:
  - auth-service:auth-service
  stdin_open: true<br>
</code></pre></blockquote>
<p>我们正在用Rancher Compose来启动一个多主机环境，这和生产环境几乎一摸一样，同时也允许我们与其它服务一同测试集成环境，比如Rancher和Docker Hub等。
这和我们之前基于docker compose构建的仅限于作为独立的外部服务、在CI服务器上运行且不会向dockerhub提交镜像的环境不同，</p>

<p>现在我们要用Rancher Compose来构建一个多主机测试环境，而不是Docker Compose，我们同样需要定义一个rancher compose模版。
创建一个名为rancher-compose.yml的文件，然后添加下述内容。在这个文件中，我们为auth服务定义了2个容器，一个用来运行数据库，另一个运行负载均衡。</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
  scale: 2
mysql-master:
  scale: 1
auth-lb
  scale: 1<br>
</code></pre></blockquote>

<p>接下来，我们为auth-service增加一个健康检查服务，确保我们能过检测这些容器何时能够启动并接受请求。
所以，我们为go-auth服务添加“/health” URI。auth-service在rancher-compose.yml文件中看起来应该是这个样子的：
</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
auth-service
  scale: 1
  health_check:
    port: 9000
    interval: 2000
    unhealthy_threshold: 3
    request_line: GET /health HTTP/1.0
    healthy_threshold: 2 
    response_timeout: 2000
    
</code></pre></blockquote>
<p>我们在容器的9000端口上定义了一个健康检查，每2秒钟运行一次。它会向“/health”这个URI发送http请求，3个连续失败将标记容器为“不健康”，
2个连续成功则标记该容器为“健康”。</p>

<h3>使用Rancher Compose创建应用栈</h3>
<p>现在，我们已经定义好了模版，可以使用Rancher compose来启动我们的环境了。简单分为如下几步。
从<a href="https://github.com/usmanismail/go-messenger">go-messenger project</a>下载rancher-compose CLI。
按照<a http://docs.rancher.com/rancher/rancher-compose/">rancher-compose</a>的帮助安装好rancher-compose。
一切安装好以后，按照下面的命令设置你的集成环境。</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
git clone https://github.com/usmanismail/go-messenger.git
cd go-messenger/deploy

#replace rancher-compose with the latest version you downloaded from rancher UI
./rancher-compose  --project-name messenger-int \
    --url http://YOUR_RANCHER_SERVER:PORT/v1/   \
    --access-key <API_KEY>                      \
    --secret-key <SECRET_KEY>                   \
    --verbose create
    
</code></pre></blockquote>
<p>在UI中，你也应该能够看到stack和services了。注意，“create”命令只创建Stack但是不启动Service，你可以通过UI或者rancher-compose命令行来启动他们。</p>
<p align="center"><img src="images/messenger-int-stack-not-started1.png" style="width:auto;max-width:700px"></p>
<p>让我们尝试用rancher-compose命令行来启动服务。</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
./rancher-compose  --project-name messenger-int \
    --url http://YOUR_RANCHER_SERVER:PORT/v1/   \
    --access-key <API_KEY>                      \
    --secret-key <SECRET_KEY>                   \
    --verbose start
    
</code></pre></blockquote>
<p>为确保所有服务工作正常，使用“auth-lb”服务所在主机的公共IP用下述命令创建一个用户。应该收到“200 OK”。
重复请求，应该收到“409 error”错误，说明数据库中已经存在此用户了。
到此，我们已经拥有了一个基本的集成环境，作为我们应用后续使用的长测环境</p>
<blockquote style="background-color:#e5e5e5"><pre><code>
curl -i -silent -X PUT -d userid=<TEST_USERNAME> -d password=<TEST_PASS> <HOST_IP_FOR_AUTH_LB>:9000/user
    
</code></pre></blockquote>

<h3>使用Rancher和AWS Route53管理DNS纪录</h3>
<p>因为这个环境要作为长测环境并对外可访问，所以我们要配置DNS和HTTPS。
这让我们可以在公司防火墙外更加安全的部署应用，同时用户也不必担心IP变化可能带来的困扰。
你可以自己选择DNS服务商，但今天我们要采用Amazon Route53来进行演示。
首先，在“AWS Console > Route 53 > Hosted Zones”里创建“Hosted Zone”。
这里，你要指定一个域名。同时，你也可以创建一个用户，为后续Rancher动态更新DNS纪录所用。
创建的路径是“AWS Console > IAMS > Users”，选择“Create New Users”。
注意保存好“Access Key”和“Secret Key”，后边会用到。
另外，你要给这个用户添加“AmazonRoute53FullAccess”才行，才能实现与Rancher的联动控制。</p>
<p>都弄好以后，在rancher server上选择“Applications > Catalog”并添加“Route 53 DNS”。
填写你之前纪录的“Hosted Zone”以及“Access Key”和“Secret Key”。
完成以后，在你的stack中就会看到一个叫做“route53”的服务。</p>
<p align="center"><img src="images/Screen-Shot-2015-11-12-at-10.40.51-PM.png" style="width:auto;max-width:300px"></p>
<p>这个服务将会监听Rancher的事件，根据负载均衡的变化，自动的调整DNS纪录。
DNS纪录的格式是“[Loadbalancer].[stack].[environment].[domain]”，例如“goauth.integration.testing.gomessenger.com”。
有了Route53，负载均衡实例和数量变化的时候，我们就不用担心获取最新IP和主机名的问题了。</p>

<h3>添加HTTPS支持</h3>











</body>
</html>